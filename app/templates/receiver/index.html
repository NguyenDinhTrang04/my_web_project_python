{% extends 'base.html' %}
{% block content %}
<div class="container">
    <div class="header">
        <h1>üîê H·ªá Th·ªëng G·ª≠i B√°o C√°o T√†i Ch√≠nh An To√†n - <span class="text-success">Ng∆∞·ªùi Nh·∫≠n</span></h1>
        <p>M√£ h√≥a AES-GCM + RSA 1024-bit + SHA-512 + N√©n zlib</p>
    </div>
    <div class="content">
        <div class="security-info">
            <h3>üõ°Ô∏è ƒê·∫∑c ƒêi·ªÉm B·∫£o M·∫≠t</h3>
            <ul class="security-list">
                <li>M√£ h√≥a d·ªØ li·ªáu: AES-GCM 256-bit</li>
                <li>Trao kh√≥a & k√Ω s·ªë: RSA 1024-bit (PKCS#1 v1.5)</li>
                <li>Ki·ªÉm tra to√†n v·∫πn: SHA-512</li>
                <li>N√©n d·ªØ li·ªáu: zlib ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc</li>
                <li>Handshake an to√†n v·ªõi x√°c th·ª±c hai chi·ªÅu</li>
            </ul>
        </div>
        <div class="section mb-4">
            <h2>ü§ù Handshake b·∫£o m·∫≠t</h2>
            <div id="handshake-message" class="mb-2"></div>
            <button id="reply-handshake" class="btn btn-success mb-2" style="display:none;"><i class="bi bi-arrow-repeat"></i> B·∫Øt tay l·∫°i</button>
            <div id="handshake-status" class="alert alert-secondary" style="display:none;"></div>
        </div>
        <div class="section mb-4">
            <h2>üìù X√°c th·ª±c metadata</h2>
            <form id="verify-metadata-form">
                <div class="mb-2">
                    <label class="form-label fw-bold">T√™n ng∆∞·ªùi g·ª≠i</label>
                    <input type="text" class="form-control" id="sender_username" name="sender_username" placeholder="Nh·∫≠p username ng∆∞·ªùi g·ª≠i" required>
                </div>
                <div class="mb-2">
                    <label class="form-label fw-bold">Metadata (JSON)</label>
                    <textarea class="form-control" id="metadata" name="metadata" rows="3" placeholder='{"filename":..., "timestamp":..., "filetype":...}' required></textarea>
                </div>
                <div class="mb-2">
                    <label class="form-label fw-bold">Ch·ªØ k√Ω (base64)</label>
                    <textarea class="form-control" id="signature" name="signature" rows="2" placeholder="D√°n ch·ªØ k√Ω metadata" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">X√°c th·ª±c metadata</button>
            </form>
            <div id="verify-metadata-result" class="mt-2"></div>
        </div>
        <div class="section mb-4">
            <h2>üë§ Th√¥ng tin t√†i kho·∫£n</h2>
            <div class="card mb-3">
                <div class="card-body">
                    <p><b>T√™n ƒëƒÉng nh·∫≠p:</b> {{ user_info.username }}</p>
                    <p><b>Public Key:</b><br><textarea class="form-control" rows="3" readonly>{{ user_info.public_key }}</textarea></p>
                    <p><b>Private Key (tr√¨nh duy·ªát l∆∞u):</b><br>
                        <textarea class="form-control" id="show_private_key" rows="3" readonly></textarea>
                        <button class="btn btn-outline-secondary mt-2" type="button" onclick="showPrivateKey()">Hi·ªán Private Key</button>
                    </p>
                </div>
            </div>
        </div>
        <div class="section">
            <h2>üì• File ƒê√£ Nh·∫≠n</h2>
            <button class="btn btn-success mb-3" id="refresh-files"><i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi danh s√°ch file</button>
            <div id="received-files-list">
                <!-- Danh s√°ch file s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const currentUsername = "{{ current_username }}";
let socket = io();
socket.on('connect', function() {
    socket.emit('register_username', {username: currentUsername});
});

const handshakeMessage = document.getElementById('handshake-message');
const handshakeStatus = document.getElementById('handshake-status');
const replyBtn = document.getElementById('reply-handshake');

// Nh·∫≠n handshake_hello t·ª´ ng∆∞·ªùi g·ª≠i
socket.on('handshake_hello', function(data) {
    handshakeMessage.innerText = data.message;
    handshakeStatus.style.display = 'none';
    replyBtn.style.display = 'inline-block';
    // L∆∞u l·∫°i sender ƒë·ªÉ reply
    replyBtn.dataset.sender = data.sender;
});

replyBtn.onclick = function() {
    const sender = replyBtn.dataset.sender;
    if (!sender) return;
    socket.emit('handshake_ready', {
        sender: currentUsername, // ng∆∞·ªùi nh·∫≠n
        receiver: sender,        // ng∆∞·ªùi g·ª≠i
        message: 'Ready'
    });
    handshakeStatus.style.display = 'block';
    handshakeStatus.className = 'alert alert-info';
    handshakeStatus.innerText = 'ƒê√£ g·ª≠i x√°c nh·∫≠n b·∫Øt tay l·∫°i!';
    replyBtn.style.display = 'none';
};

// X√°c th·ª±c metadata
const verifyForm = document.getElementById('verify-metadata-form');
verifyForm.onsubmit = async function(e) {
    e.preventDefault();
    const sender = document.getElementById('sender_username').value.trim();
    const metadata = document.getElementById('metadata').value.trim();
    const signature = document.getElementById('signature').value.trim();
    const resultDiv = document.getElementById('verify-metadata-result');
    if (!sender || !metadata || !signature) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!</div>';
        return;
    }
    resultDiv.innerHTML = '<div class="alert alert-info">ƒêang x√°c th·ª±c...</div>';
    try {
        const response = await fetch('/api/verify_metadata', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({sender_username: sender, metadata: metadata, signature: signature})
        });
        const data = await response.json();
        if (data.status === 'success') {
            resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
        }
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói x√°c th·ª±c!</div>';
    }
};

async function loadReceivedFiles() {
    const listDiv = document.getElementById('received-files-list');
    listDiv.innerHTML = '<div class="text-center text-secondary">ƒêang t·∫£i danh s√°ch file...</div>';
    try {
        const response = await fetch('/list_received_files');
        const data = await response.json();
        if (data.status === 'success' && data.files.length > 0) {
            let html = '<ul class="list-group">';
            data.files.forEach(f => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class='bi bi-file-earmark-text'></i> ${f.name} <span class='text-muted small'>(${(f.size/1024).toFixed(1)} KB)</span></span>
                    <a href="/download_file/${encodeURIComponent(f.name)}" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> T·∫£i v·ªÅ</a>
                </li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
        } else {
            listDiv.innerHTML = '<div class="alert alert-warning">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c nh·∫≠n.</div>';
        }
    } catch (err) {
        listDiv.innerHTML = '<div class="alert alert-danger">L·ªói t·∫£i danh s√°ch file!</div>';
    }
}
document.getElementById('refresh-files').onclick = loadReceivedFiles;
window.onload = loadReceivedFiles;

function showPrivateKey() {
    const key = localStorage.getItem('private_key') || '';
    document.getElementById('show_private_key').value = key;
}

// H√†m h·ªó tr·ª£: chuy·ªÉn PEM private key -> CryptoKey
async function importPrivateKey(pem) {
    const pemHeader = "-----BEGIN PRIVATE KEY-----";
    const pemFooter = "-----END PRIVATE KEY-----";
    let pemContents = pem.replace(pemHeader, '').replace(pemFooter, '').replace(/\s/g, '');
    const binaryDer = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));
    return await window.crypto.subtle.importKey(
        'pkcs8',
        binaryDer.buffer,
        {
            name: 'RSA-OAEP',
            hash: 'SHA-256',
        },
        false,
        ['decrypt']
    );
}

// H√†m gi·∫£i m√£ session key b·∫±ng private key
async function decryptSessionKey(encryptedSessionKeyB64, privateKeyPem) {
    const privateKey = await importPrivateKey(privateKeyPem);
    const encrypted = Uint8Array.from(atob(encryptedSessionKeyB64), c => c.charCodeAt(0));
    const sessionKeyRaw = await window.crypto.subtle.decrypt(
        { name: 'RSA-OAEP' },
        privateKey,
        encrypted
    );
    // Import l·∫°i session key AES
    return await window.crypto.subtle.importKey(
        'raw',
        sessionKeyRaw,
        { name: 'AES-GCM' },
        false,
        ['decrypt']
    );
}

// H√†m gi·∫£i m√£ file b·∫±ng session key
async function decryptFileWithSessionKey(encryptedFileObj, sessionKey) {
    const iv = new Uint8Array(encryptedFileObj.iv);
    const encrypted = new Uint8Array(encryptedFileObj.encrypted);
    const decrypted = await window.crypto.subtle.decrypt(
        { name: 'AES-GCM', iv: iv },
        sessionKey,
        encrypted
    );
    return new Blob([decrypted]);
}

// Nh·∫≠n session key t·ª´ sender
let receivedSessionKey = null;
socket.on('receive_session_key', async function(data) {
    const privateKey = localStorage.getItem('private_key') || '';
    if (!privateKey) {
        alert('Kh√¥ng t√¨m th·∫•y private key ƒë·ªÉ gi·∫£i m√£ session key!');
        return;
    }
    try {
        receivedSessionKey = await decryptSessionKey(data.encrypted_session_key, privateKey);
        alert('ƒê√£ nh·∫≠n v√† gi·∫£i m√£ session key th√†nh c√¥ng!');
    } catch (err) {
        alert('L·ªói gi·∫£i m√£ session key: ' + err);
    }
});

// Nh·∫≠n file m√£ h√≥a t·ª´ sender
socket.on('receive_file_data', async function(data) {
    const fileName = data.filename;
    const encryptedFileObj = data.encrypted_file;
    const encryptedSessionKeyB64 = data.encrypted_session_key;
    const senderPrivateKey = data.sender_private_key;
    if (!receivedSessionKey) {
        alert('Ch∆∞a nh·∫≠n ƒë∆∞·ª£c ho·∫∑c gi·∫£i m√£ session key!');
        return;
    }
    try {
        const decryptedBlob = await decryptFileWithSessionKey(encryptedFileObj, receivedSessionKey);
        // T·∫°o link t·∫£i file
        const url = URL.createObjectURL(decryptedBlob);
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = fileName;
        downloadLink.textContent = `T·∫£i file ƒë√£ gi·∫£i m√£: ${fileName}`;
        // Hi·ªÉn th·ªã th√¥ng b√°o
        alert(`ƒê√£ nh·∫≠n file: ${fileName}\nKh√≥a gi·∫£i m√£ (private key sender):\n${senderPrivateKey}`);
        // Th√™m link t·∫£i v√†o giao di·ªán
        const listDiv = document.getElementById('received-files-list');
        const info = document.createElement('div');
        info.innerHTML = `<div class='alert alert-success'>ƒê√£ nh·∫≠n file: <b>${fileName}</b><br>Kh√≥a gi·∫£i m√£ (private key sender):<br><textarea class='form-control' rows='3' readonly>${senderPrivateKey}</textarea></div>`;
        listDiv.prepend(info);
        listDiv.prepend(downloadLink);
    } catch (err) {
        alert('L·ªói gi·∫£i m√£ file: ' + err);
    }
});
</script>
{% endblock %}
