{% extends 'base.html' %}
{% block content %}
<div class="container">
    <div class="header">
        <h1>üîê H·ªá Th·ªëng G·ª≠i B√°o C√°o T√†i Ch√≠nh An To√†n - <span class="text-primary">Ng∆∞·ªùi G·ª≠i</span></h1>
        <p>M√£ h√≥a AES-GCM + RSA 1024-bit + SHA-512 + N√©n zlib</p>
    </div>
    <div class="content">
        <div class="security-info">
            <h3>üõ°Ô∏è ƒê·∫∑c ƒêi·ªÉm B·∫£o M·∫≠t</h3>
            <ul class="security-list">
                <li>M√£ h√≥a d·ªØ li·ªáu: AES-GCM 256-bit</li>
                <li>Trao kh√≥a & k√Ω s·ªë: RSA 1024-bit (PKCS#1 v1.5)</li>
                <li>Ki·ªÉm tra to√†n v·∫πn: SHA-512</li>
                <li>N√©n d·ªØ li·ªáu: zlib ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc</li>
                <li>Handshake an to√†n v·ªõi x√°c th·ª±c hai chi·ªÅu</li>
            </ul>
        </div>
        <div class="section mb-4">
            <h2>ü§ù Handshake b·∫£o m·∫≠t</h2>
            <div class="mb-2">
                <label for="receiver_username" class="form-label fw-bold">T√™n ng∆∞·ªùi nh·∫≠n</label>
                <input type="text" class="form-control" id="receiver_username" name="receiver_username" placeholder="Nh·∫≠p username ng∆∞·ªùi nh·∫≠n" required>
            </div>
            <button id="start-handshake" class="btn btn-warning mb-2"><i class="bi bi-link-45deg"></i> B·∫Øt ƒë·∫ßu handshake</button>
            <div id="handshake-status" class="alert alert-secondary" style="display:none;"></div>
        </div>
        <div class="section">
            <h2>üìÅ G·ª≠i File T√†i Ch√≠nh</h2>
            <form id="send-file-form" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="file" class="form-label fw-bold">Ch·ªçn file ƒë·ªÉ g·ª≠i</label>
                    <input class="form-control" type="file" id="file" name="file" required>
                </div>
                <div class="mb-3">
                    <label for="private_key" class="form-label fw-bold">Private Key (PEM)</label>
                    <div class="input-group">
                        <textarea class="form-control" id="private_key" name="private_key" rows="4" placeholder="D√°n private key PEM c·ªßa b·∫°n t·∫°i ƒë√¢y" required></textarea>
                        <button class="btn btn-outline-secondary" type="button" id="fill-private-key">T·ª± ƒëi·ªÅn kh√≥a</button>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-upload"></i> G·ª≠i File</button>
                </div>
            </form>
            <div id="send-file-result" class="mt-3"></div>
        </div>
        <div class="section mb-4">
            <h2>üë§ Th√¥ng tin t√†i kho·∫£n</h2>
            <div class="card mb-3">
                <div class="card-body">
                    <p><b>T√™n ƒëƒÉng nh·∫≠p:</b> {{ user_info.username }}</p>
                    <p><b>Public Key:</b><br><textarea class="form-control" rows="3" readonly>{{ user_info.public_key }}</textarea></p>
                    <p><b>Private Key (tr√¨nh duy·ªát l∆∞u):</b><br>
                        <textarea class="form-control" id="show_private_key" rows="3" readonly></textarea>
                        <button class="btn btn-outline-secondary mt-2" type="button" onclick="showPrivateKey()">Hi·ªán Private Key</button>
                    </p>
                </div>
            </div>
        </div>
        <div class="section mb-4">
            <h2>üîë Trao ƒë·ªïi Session Key</h2>
            <button id="gen-session-key" class="btn btn-info mb-2">T·∫°o & g·ª≠i Session Key</button>
            <div id="session-key-status" class="alert alert-secondary" style="display:none;"></div>
        </div>
    </div>
</div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const currentUsername = "{{ current_username }}";
let socket = io();
// ƒêƒÉng k√Ω username v·ªõi server khi k·∫øt n·ªëi socket
socket.on('connect', function() {
    socket.emit('register_username', {username: currentUsername});
});

const handshakeBtn = document.getElementById('start-handshake');
const handshakeStatus = document.getElementById('handshake-status');

handshakeBtn.onclick = function() {
    const receiver = document.getElementById('receiver_username').value.trim();
    if (!receiver) {
        handshakeStatus.style.display = 'block';
        handshakeStatus.className = 'alert alert-danger';
        handshakeStatus.innerText = 'Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!';
        return;
    }
    handshakeStatus.style.display = 'block';
    handshakeStatus.className = 'alert alert-info';
    handshakeStatus.innerText = 'ƒêang g·ª≠i b·∫Øt tay...';
    socket.emit('handshake_hello', {
        sender: currentUsername,
        receiver: receiver,
        message: 'Hello'
    });
};

// Nh·∫≠n ph·∫£n h·ªìi handshake_ready t·ª´ ng∆∞·ªùi nh·∫≠n
socket.on('handshake_ready', function(data) {
    handshakeStatus.style.display = 'block';
    handshakeStatus.className = 'alert alert-success';
    handshakeStatus.innerText = data.message;
});

// H√†m h·ªó tr·ª£: chuy·ªÉn PEM -> CryptoKey
async function importPrivateKey(pem) {
    // Lo·∫°i b·ªè header/footer v√† newline
    const pemHeader = "-----BEGIN PRIVATE KEY-----";
    const pemFooter = "-----END PRIVATE KEY-----";
    let pemContents = pem.replace(pemHeader, '').replace(pemFooter, '').replace(/\s/g, '');
    const binaryDer = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));
    return await window.crypto.subtle.importKey(
        'pkcs8',
        binaryDer.buffer,
        {
            name: 'RSASSA-PKCS1-v1_5',
            hash: 'SHA-512',
        },
        false,
        ['sign']
    );
}

// H√†m h·ªó tr·ª£: chuy·ªÉn PEM public key -> CryptoKey
async function importPublicKey(pem) {
    const pemHeader = "-----BEGIN PUBLIC KEY-----";
    const pemFooter = "-----END PUBLIC KEY-----";
    let pemContents = pem.replace(pemHeader, '').replace(pemFooter, '').replace(/\s/g, '');
    const binaryDer = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));
    return await window.crypto.subtle.importKey(
        'spki',
        binaryDer.buffer,
        {
            name: 'RSA-OAEP',
            hash: 'SHA-256',
        },
        false,
        ['encrypt']
    );
}

// H√†m sinh session key AES 256 bit
async function generateSessionKey() {
    return await window.crypto.subtle.generateKey(
        { name: 'AES-GCM', length: 256 },
        true,
        ['encrypt', 'decrypt']
    );
}

// H√†m export session key ra ArrayBuffer
async function exportSessionKey(key) {
    return await window.crypto.subtle.exportKey('raw', key);
}

// H√†m m√£ h√≥a session key b·∫±ng public key ng∆∞·ªùi nh·∫≠n
async function encryptSessionKey(sessionKeyBuffer, receiverPublicKeyPem) {
    const publicKey = await importPublicKey(receiverPublicKeyPem);
    return await window.crypto.subtle.encrypt(
        { name: 'RSA-OAEP' },
        publicKey,
        sessionKeyBuffer
    );
}

// H√†m t·∫°o metadata
function createMetadata(file) {
    return {
        filename: file.name,
        timestamp: new Date().toISOString(),
        filetype: file.type
    };
}

// H√†m k√Ω metadata
async function signMetadata(metadata, privateKeyPem) {
    const privateKey = await importPrivateKey(privateKeyPem);
    const encoder = new TextEncoder();
    const data = encoder.encode(JSON.stringify(metadata));
    const signature = await window.crypto.subtle.sign(
        {
            name: 'RSASSA-PKCS1-v1_5',
        },
        privateKey,
        data
    );
    // Tr·∫£ v·ªÅ base64 signature
    return btoa(String.fromCharCode(...new Uint8Array(signature)));
}

// G·ª≠i file k√®m metadata v√† ch·ªØ k√Ω
const sendFileForm = document.getElementById('send-file-form');
sendFileForm.onsubmit = async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('file');
    const privateKeyInput = document.getElementById('private_key');
    const receiverInput = document.getElementById('receiver_username');
    const resultDiv = document.getElementById('send-file-result');
    if (!fileInput.files[0] || !privateKeyInput.value.trim() || !receiverInput.value.trim()) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!</div>';
        return;
    }
    const file = fileInput.files[0];
    const privateKeyPem = privateKeyInput.value.trim();
    const receiver = receiverInput.value.trim();
    // T·∫°o metadata
    const metadata = createMetadata(file);
    // K√Ω metadata
    let signature = '';
    try {
        signature = await signMetadata(metadata, privateKeyPem);
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói k√Ω metadata: ' + err + '</div>';
        return;
    }
    // G·ª≠i l√™n server
    const formData = new FormData();
    formData.append('file', file);
    formData.append('receiver_username', receiver);
    formData.append('metadata', JSON.stringify(metadata));
    formData.append('signature', signature);
    resultDiv.innerHTML = '<div class="alert alert-info">ƒêang g·ª≠i file...</div>';
    try {
        const response = await fetch('/upload_file', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.status === 'success') {
            resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
        }
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói g·ª≠i file!</div>';
    }
};

// N√∫t t·ª± ƒëi·ªÅn private key
const fillKeyBtn = document.getElementById('fill-private-key');
if (fillKeyBtn) {
    fillKeyBtn.onclick = function() {
        // L·∫•y private key t·ª´ localStorage (gi·∫£ s·ª≠ ƒë√£ l∆∞u sau khi t·∫°o kh√≥a ·ªü ƒëƒÉng nh·∫≠p)
        const savedKey = localStorage.getItem('private_key');
        if (savedKey) {
            document.getElementById('private_key').value = savedKey;
            fillKeyBtn.classList.add('btn-success');
            fillKeyBtn.textContent = 'ƒê√£ ƒëi·ªÅn!';
            setTimeout(() => {
                fillKeyBtn.classList.remove('btn-success');
                fillKeyBtn.textContent = 'T·ª± ƒëi·ªÅn kh√≥a';
            }, 2000);
        } else {
            alert('Kh√¥ng t√¨m th·∫•y private key trong tr√¨nh duy·ªát. H√£y t·∫°o ho·∫∑c nh·∫≠p th·ªß c√¥ng!');
        }
    }
}

// H√†m hi·ªÉn th·ªã private key
function showPrivateKey() {
    const key = localStorage.getItem('private_key') || '';
    document.getElementById('show_private_key').value = key;
}

let lastSessionKey = null;
let lastEncryptedSessionKey = null;
let lastReceiver = null;

// G·ª≠i session key qua WebSocket
async function sendSessionKeyWS(receiver, encryptedSessionKey) {
    socket.emit('send_session_key', {
        sender: currentUsername,
        receiver: receiver,
        encrypted_session_key: btoa(String.fromCharCode(...new Uint8Array(encryptedSessionKey)))
    });
}

// X·ª≠ l√Ω n√∫t t·∫°o & g·ª≠i session key
const genSessionKeyBtn = document.getElementById('gen-session-key');
const sessionKeyStatus = document.getElementById('session-key-status');
genSessionKeyBtn.onclick = async function() {
    const receiver = document.getElementById('receiver_username').value.trim();
    if (!receiver) {
        sessionKeyStatus.style.display = 'block';
        sessionKeyStatus.className = 'alert alert-danger';
        sessionKeyStatus.innerText = 'Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!';
        return;
    }
    sessionKeyStatus.style.display = 'block';
    sessionKeyStatus.className = 'alert alert-info';
    sessionKeyStatus.innerText = 'ƒêang l·∫•y public key ng∆∞·ªùi nh·∫≠n...';
    // L·∫•y public key ng∆∞·ªùi nh·∫≠n t·ª´ API
    let receiverPublicKey = '';
    try {
        const res = await fetch(`/api/public_key/${encodeURIComponent(receiver)}`);
        const data = await res.json();
        if (data.status === 'success') {
            receiverPublicKey = data.public_key;
        } else {
            sessionKeyStatus.className = 'alert alert-danger';
            sessionKeyStatus.innerText = 'Kh√¥ng t√¨m th·∫•y public key ng∆∞·ªùi nh·∫≠n!';
            return;
        }
    } catch (err) {
        sessionKeyStatus.className = 'alert alert-danger';
        sessionKeyStatus.innerText = 'L·ªói l·∫•y public key ng∆∞·ªùi nh·∫≠n!';
        return;
    }
    sessionKeyStatus.innerText = 'ƒêang sinh session key...';
    // Sinh session key
    let sessionKey;
    try {
        sessionKey = await generateSessionKey();
    } catch (err) {
        sessionKeyStatus.className = 'alert alert-danger';
        sessionKeyStatus.innerText = 'L·ªói sinh session key!';
        return;
    }
    // Export session key ra buffer
    const sessionKeyBuffer = await exportSessionKey(sessionKey);
    // M√£ h√≥a session key b·∫±ng public key ng∆∞·ªùi nh·∫≠n
    let encryptedSessionKey;
    try {
        encryptedSessionKey = await encryptSessionKey(sessionKeyBuffer, receiverPublicKey);
    } catch (err) {
        sessionKeyStatus.className = 'alert alert-danger';
        sessionKeyStatus.innerText = 'L·ªói m√£ h√≥a session key!';
        return;
    }
    // L∆∞u l·∫°i session key cho b∆∞·ªõc m√£ h√≥a file
    lastSessionKey = sessionKey;
    lastEncryptedSessionKey = encryptedSessionKey;
    lastReceiver = receiver;
    // G·ª≠i session key ƒë√£ m√£ h√≥a qua WebSocket
    sendSessionKeyWS(receiver, encryptedSessionKey);
    sessionKeyStatus.className = 'alert alert-success';
    sessionKeyStatus.innerText = 'ƒê√£ g·ª≠i session key th√†nh c√¥ng!';
};

// H√†m m√£ h√≥a file b·∫±ng session key (AES-GCM)
async function encryptFileWithSessionKey(file, sessionKey) {
    const iv = window.crypto.getRandomValues(new Uint8Array(12));
    const fileBuffer = await file.arrayBuffer();
    const encrypted = await window.crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: iv },
        sessionKey,
        fileBuffer
    );
    // Tr·∫£ v·ªÅ {iv, encrypted}
    return {iv: Array.from(iv), encrypted: Array.from(new Uint8Array(encrypted))};
}

// G·ª≠i file m√£ h√≥a qua WebSocket
async function sendFileWS(receiver, filename, encryptedFile, encryptedSessionKey, senderPrivateKey) {
    socket.emit('send_file_data', {
        sender: currentUsername,
        receiver: receiver,
        filename: filename,
        encrypted_file: encryptedFile,
        encrypted_session_key: btoa(String.fromCharCode(...new Uint8Array(encryptedSessionKey))),
        sender_private_key: senderPrivateKey
    });
}

// G·ª≠i file k√®m session key v√† private key qua WebSocket
sendFileForm.onsubmit = async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('file');
    const privateKeyInput = document.getElementById('private_key');
    const receiverInput = document.getElementById('receiver_username');
    const resultDiv = document.getElementById('send-file-result');
    if (!fileInput.files[0] || !privateKeyInput.value.trim() || !receiverInput.value.trim()) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!';
        return;
    }
    const file = fileInput.files[0];
    const privateKeyPem = privateKeyInput.value.trim();
    const receiver = receiverInput.value.trim();
    if (!lastSessionKey || !lastEncryptedSessionKey || lastReceiver !== receiver) {
        resultDiv.innerHTML = '<div class="alert alert-danger">B·∫°n c·∫ßn t·∫°o v√† g·ª≠i session key tr∆∞·ªõc khi g·ª≠i file!';
        return;
    }
    resultDiv.innerHTML = '<div class="alert alert-info">ƒêang m√£ h√≥a v√† g·ª≠i file...';
    // M√£ h√≥a file b·∫±ng session key
    let encryptedFileObj;
    try {
        encryptedFileObj = await encryptFileWithSessionKey(file, lastSessionKey);
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói m√£ h√≥a file!';
        return;
    }
    // G·ª≠i file m√£ h√≥a, session key m√£ h√≥a, private key qua WebSocket
    sendFileWS(receiver, file.name, encryptedFileObj, lastEncryptedSessionKey, privateKeyPem);
    resultDiv.innerHTML = '<div class="alert alert-success">ƒê√£ g·ª≠i file m√£ h√≥a th√†nh c√¥ng!';
};
</script>
{% endblock %}
